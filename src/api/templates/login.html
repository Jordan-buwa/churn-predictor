{% extends "base_auth.html" %}

{% block title %}Login - Churn Prediction API{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-lg border-0">
            <div class="card-header text-center py-4">
                <h3 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i>Login</h3>
                <p class="text-muted mb-0">Access your Churn Prediction account</p>
            </div>
            <div class="card-body p-4">
                <!-- Login Form -->
                <form id="loginForm" method="POST" action="/auth/login">
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="fas fa-user me-1"></i>Username
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-user text-muted"></i>
                            </span>
                            <input type="text" 
                                   class="form-control border-start-0" 
                                   id="username" 
                                   name="username"
                                   placeholder="Enter your username" 
                                   required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock me-1"></i>Password
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-lock text-muted"></i>
                            </span>
                            <input type="password" 
                                   class="form-control border-start-0" 
                                   id="password" 
                                   name="password"
                                   placeholder="Enter your password" 
                                   required>
                            <button class="btn btn-outline-secondary border-start-0" type="button" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </div>

                    <div class="text-center">
                        <p class="mb-0">
                            Don't have an account? 
                            <a href="/pages/register" class="text-decoration-none">Register here</a>
                        </p>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{{ super() }}
<script>
    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('password');
        const icon = this.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Form submission handling
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Logging in...';
    
    try {
        const formData = new FormData(this);
        console.log('Attempting login with username:', document.getElementById('username').value);
        
        const response = await fetch('/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
        });
        
        console.log('Login response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Login successful, token received:', result.access_token ? 'YES' : 'NO');
            console.log('User data:', result.user);
            
            // Store token in localStorage
            if (result.access_token) {
                localStorage.setItem('access_token', result.access_token);
                localStorage.setItem('user', JSON.stringify(result.user));
                console.log('Token stored in localStorage');
                
                // TEST: Vérifier immédiatement si le token fonctionne
                const testResponse = await fetch('/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${result.access_token}`
                    }
                });
                console.log('Token test response:', testResponse.status);
                
                if (testResponse.ok) {
                    // Show success message and redirect
                    showAlert('Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/home';
                    }, 1000);
                } else {
                    showAlert('Login issue detected. Please try again.', 'warning');
                }
            } else {
                showAlert('No token received from server.', 'danger');
            }
        } else {
            const error = await response.json();
            console.log('Login failed:', error);
            showAlert(error.detail || 'Login failed. Please try again.', 'danger');
        }
    } catch (error) {
        console.error('Login error:', error);
        showAlert('Network error. Please try again.', 'danger');
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

    // Alert function
    function showAlert(message, type) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('#loginForm'));
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', async function() {
    const token = localStorage.getItem('access_token');
    if (token) {
        try {
            const response = await fetch('/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                // User is already logged in, redirect to home
                console.log('User already logged in, redirecting to home');
                window.location.href = '/home';
            } else {
                // Token is invalid, remove it
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
        }
    }
});
</script>
{% endblock %}