name: Data Version Control

on:
  push:
    branches: [ main ]

jobs:
  data-version-control:
    runs-on: ubuntu-latest

    env:
      AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
      AZURE_STORAGE_SAS_TOKEN: ${{ secrets.AZURE_STORAGE_SAS_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install DVC and Azure support
        run: pip install dvc[azure]

      - name: Configure DVC remotes
        run: |
          dvc remote add -f -d azureblob azure://dvc-remote/churn_data
          dvc remote modify azureblob account_name $AZURE_STORAGE_ACCOUNT_NAME
          dvc remote modify azureblob sas_token $AZURE_STORAGE_SAS_TOKEN

          dvc remote add -f churn_models azure://dvc-remote/models
          dvc remote modify churn_models account_name $AZURE_STORAGE_ACCOUNT_NAME
          dvc remote modify churn_models sas_token $AZURE_STORAGE_SAS_TOKEN

      - name: Pull data and models
        run: |
          dvc pull -r azureblob --force
          dvc pull -r churn_models --force

      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Add, commit, and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          dvc add data/snapshots models
          dvc push

          git add data/snapshots.dvc models.dvc .dvc/config
          git commit -m "Auto: Update DVC data and models"
          git push
