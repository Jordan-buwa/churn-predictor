name: Churn Prediction CI/CD

on:
  push:
    branches: 
      - main
      - dev/api
      - dev/data-pipeline
      - dev/training
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # Determine which services to build based on branch or changed files
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      build-api: ${{ steps.changes.outputs.api }}
      build-data-pipeline: ${{ steps.changes.outputs.data-pipeline }}
      build-training: ${{ steps.changes.outputs.training }}
      deploy: ${{ steps.changes.outputs.deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          # Default: don't build anything
          BUILD_API="false"
          BUILD_DATA="false"
          BUILD_TRAINING="false"
          DEPLOY="false"
          
          if [[ "$BRANCH_NAME" == "main" ]]; then
            # On main, check what files changed in the merge
            if [[ "${{ github.event_name }}" == "push" ]]; then
              # Get files changed comparing to previous commit
              if [[ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
                CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
              else
                # First commit or force push - build everything
                CHANGED_FILES=$(git ls-files)
              fi
              
              echo "Changed files:"
              echo "$CHANGED_FILES"
              
              # Check if API files changed
              if echo "$CHANGED_FILES" | grep -qE '(src/api/|docker/api/|requirements\.txt|^\.github/)'; then
                BUILD_API="true"
                echo "API changes detected"
              fi
              
              # Check if data pipeline files changed
              if echo "$CHANGED_FILES" | grep -qE '(src/data_pipeline/|docker/data_pipeline/|requirements\.txt|^\.github/)'; then
                BUILD_DATA="true"
                echo "Data Pipeline changes detected"
              fi
              
              # Check if training files changed
              if echo "$CHANGED_FILES" | grep -qE '(src/training/|docker/training/|requirements\.txt|^\.github/)'; then
                BUILD_TRAINING="true"
                echo "Training changes detected"
              fi
              
              # Deploy if any service needs building
              if [[ "$BUILD_API" == "true" || "$BUILD_DATA" == "true" || "$BUILD_TRAINING" == "true" ]]; then
                DEPLOY="true"
              fi
            fi
          elif [[ "$BRANCH_NAME" == "dev/api" ]]; then
            BUILD_API="true"
            echo "On dev/api branch"
          elif [[ "$BRANCH_NAME" == "dev/data-pipeline" ]]; then
            BUILD_DATA="true"
            echo "On dev/data-pipeline branch"
          elif [[ "$BRANCH_NAME" == "dev/training" ]]; then
            BUILD_TRAINING="true"
            echo "On dev/training branch"
          fi
          
          echo "build-api=$BUILD_API" >> $GITHUB_OUTPUT
          echo "build-data-pipeline=$BUILD_DATA" >> $GITHUB_OUTPUT
          echo "build-training=$BUILD_TRAINING" >> $GITHUB_OUTPUT
          echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT
          
          echo "=== Build Configuration ==="
          echo "Build API: $BUILD_API"
          echo "Build Data Pipeline: $BUILD_DATA"
          echo "Build Training: $BUILD_TRAINING"
          echo "Deploy: $DEPLOY"
